rules_version = '2';
service cloud.firestore {
    match /databases/{database}/documents {
        function hasTimestamp(field) {
            return request.resource.data[field] == request.time;
        }

        function isAuthenticated(id) {
            return request.auth != null && request.auth.uid == id;
        }

        function affectedKeys() {
            return request.resource.data.diff(resource.data).affectedKeys();
        }

        function isTeacher() {
            return request.auth != null && request.auth.token.role == 'teacher';
        }

        function getParticipation(id) {
            return get(/databases/$(database)/documents/participations/$(id));
        }

        function isTeacherParticipation(participationId) {
            let participation = getParticipation(participationId);
            return participation != null && participation.data.schoolId == request.auth.token.schoolId;
        }

        match /announcements/{announcement} {
            allow read: if isTeacher();
        }

        match /contests/{contest} {
            allow read: if true;
        }

        match /participations/{participationId} {
            allow read: if participationId == request.auth.token.participationId || resource.data.schoolId == request.auth.token.schoolId;
        }

        match /participations/{participationId}/students/{student} {
            function checkToken() {
                let participation = getParticipation(participationId);
                return participation != null
                    && participation.data.token != null
                    && participation.data.token == request.resource.data.token
                    && participation.data.startingTime == request.resource.data.startedAt
                    && participation.data.endingTime >= request.resource.data.finishedAt
                    && participation.data.contestId == request.resource.data.contestId
                    && request.time <= resource.data.finishedAt + duration.value(10, 's');
            }

            function canStudentUpdate() {
                let keys = affectedKeys();
                return isAuthenticated(resource.data.uid)
                    && checkToken()
                    && keys.hasOnly(['answers', 'updatedAt', 'finishedAt', 'extraData'])
                    && hasTimestamp('updatedAt');
            }

            function canTeacherUpdate() {
                let keys = affectedKeys();
                return isTeacherParticipation(participationId)
                    && !keys.hasAny(['participationId', 'createdAt'])
                    && hasTimestamp('updatedAt');
            }

            allow read: if isAuthenticated(resource.data.uid) || isTeacherParticipation(participationId);
            allow create: if isTeacherParticipation(participationId) && request.resource.data.participationId == participationId;
            allow update: if canStudentUpdate() || canTeacherUpdate();
            allow delete: if isTeacherParticipation(participationId);
        }

        match /studentRestores/{uid} {
            allow read: if isAuthenticated(uid) || isTeacherParticipation(resource.data.participationId);
            allow update: if isTeacherParticipation(resource.data.participationId);
            allow delete: if isTeacherParticipation(resource.data.participationId);
        }

        match /variants/{variant} {
            allow read: if isTeacher();
        }

        match /{document=**} {
            allow read, write: if request.auth.token.role == "admin";
        }
    }
}
