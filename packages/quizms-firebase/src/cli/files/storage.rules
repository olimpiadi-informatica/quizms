rules_version = '2';
service firebase.storage {
    match /b/{bucket}/o {
        function isAuthenticated(id) {
            return request.auth != null && request.auth.uid == id;
        }

        function isTeacher() {
            return request.auth != null && request.auth.token.role == 'teacher';
        }

        function getStudent() {
            return firestore.get(/databases/(default)/documents/participations/$(request.auth.token.participationId)/students/$(request.auth.token.studentId));
        }

        match /statements/{contestId}/{variantId}/{filename} {
            function canStudentReadVariant() {
                let student = getStudent();
                return student != null
                    && isAuthenticated(student.data.uid)
                    && student.data.contestId == contestId
                    && student.data.variant == variantId
                    && student.data.startedAt <= request.time;
            }

            allow read: if canStudentReadVariant() || isTeacher();
        }
    }
}
